<!DOCTYPE html>
<html>
<head>
    <title>Tic Tac Toe MQTT</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-gap: 5px;
            margin-top: 10px;
        }
        .cell {
            width: 100px;
            height: 100px;
            border: 1px solid #000;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
        }
        .clicked {
            pointer-events: none;
            font-size: 4em;
        }
    </style>
</head>
<body>
    <div>
        <label for="topic" style="font-size: 1.5em;">Enter Game Topic:</label>
        <input type="text" id="topic" style="font-size: 1.5em;" placeholder="Enter topic">
        <button id="joinButton" style="font-size: 1.5em; color: white; background-color: chocolate;">Join Game</button>
    </div>
    <div>&nbsp;</div>
    <div id="status" style="font-size: 1.5em;"></div>
    <div>&nbsp;</div>
    <div id="alert" style="color: red; font-weight: bold;"></div>
    <div class="board" style="display:none; margin-left: 58px;">
        <div class="cell" data-cell-index="0"></div>
        <div class="cell" data-cell-index="1"></div>
        <div class="cell" data-cell-index="2"></div>
        <div class="cell" data-cell-index="3"></div>
        <div class="cell" data-cell-index="4"></div>
        <div class="cell" data-cell-index="5"></div>
        <div class="cell" data-cell-index="6"></div>
        <div class="cell" data-cell-index="7"></div>
        <div class="cell" data-cell-index="8"></div>
    </div>
    <button id="resetButton" style="display:none; font-size: 2em; background-color: crimson; color: white; margin-left: 116px; margin-top: 20px;">Reset Game</button>
    <script>
        const brokerUrl = 'ws://localhost:3000';
        const clientId = 'mqtt_js_' + Math.random().toString(16).substr(2, 8);
        const client = mqtt.connect(brokerUrl, { clientId });

        let player1 = [], player2 = [], pickedBoard = [0, 1, 2, 3, 4, 5, 6, 7, 8], move = 'x', gameOverOnWin = false;
        let gameTopic = '';

        const cell = document.querySelectorAll('.cell');
        let statusText = document.getElementById('status');
        let alertText = document.getElementById('alert');

        document.getElementById('joinButton').addEventListener('click', () => {
            gameTopic = document.getElementById('topic').value;
            if (gameTopic) {
                client.subscribe(`${gameTopic}/move`);
                client.subscribe(`${gameTopic}/reset`);
                client.subscribe(`${gameTopic}/join`);
                client.publish(`${gameTopic}/join`, JSON.stringify({ clientId }));
                document.querySelector('.board').style.display = 'grid';
                document.getElementById('resetButton').style.display = 'block';
                console.log(`Joined game with topic: ${gameTopic}`);
            } else {
                alert('Please enter a game topic');
            }
        });

        client.on('connect', () => {
            console.log('Connected to MQTT broker');
        });

        client.on('message', (topic, message) => {
            const data = JSON.parse(message.toString());
            console.log(`Received message on topic ${topic}: `, data);
            if (topic === `${gameTopic}/move` && data.clientId !== clientId) {
                handleMove(data.move, data.clicked);
            } else if (topic === `${gameTopic}/reset`) {
                resetGame(true);  // true indicates it's a message from MQTT
            } else if (topic === `${gameTopic}/join` && data.clientId !== clientId) {
                showAlert('Another player has joined the game');
                setTimeout(() => alertText.innerHTML = '', 3000); // Clear the alert after 3 seconds
            }
        });

        cell.forEach(item => {
            item.addEventListener('click', e => {
                let clicked = e.target.dataset.cellIndex;
                console.log(`Cell clicked: ${clicked}`);
                if (pickedBoard[clicked] !== 'x' && pickedBoard[clicked] !== 'o' && !gameOverOnWin) {
                    const data = { move, clicked, clientId };
                    client.publish(`${gameTopic}/move`, JSON.stringify(data));
                    handleMove(move, clicked);
                }
            });
        });

        function handleMove(move, clicked) {
            console.log(`Handling move: ${move}, cell: ${clicked}`);
            cell[clicked].style.pointerEvents = "none";
            cell[clicked].innerHTML = `<p class='clicked'>${move}</p>`;
            pushPlay(move, clicked);
            if (checkIfWin()) return;
            playerTurn(move);
        }

        function playerTurn(playMove) {
            move = (playMove === 'x') ? 'o' : 'x';
            console.log(`Next move: ${move}`);
        }

        function pushPlay(player, clicked) {
            if (player === 'x') {
                player1.push(Number(clicked));
                pickedBoard[clicked] = 'x';
            } else {
                player2.push(Number(clicked));
                pickedBoard[clicked] = 'o';
            }
            console.log(`Player ${player} made a move: `, player === 'x' ? player1 : player2);
        }

        function checkIfWin() {
            const winConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8],
                [0, 3, 6], [1, 4, 7], [2, 5, 8],
                [0, 4, 8], [2, 4, 6]
            ];

            for (const condition of winConditions) {
                const [a, b, c] = condition;
                if (pickedBoard[a] === pickedBoard[b] && pickedBoard[b] === pickedBoard[c]) {
                    win(pickedBoard[a]);
                    gameOverOnWin = true;
                    return true;
                }
            }

            if (player1.length + player2.length === 9 && !gameOverOnWin) {
                draw();
                return true;
            }
            return false;
        }

        function win(winner) {
            statusText.innerHTML = 'The winner is ' + winner;
            gameOverOnWin = true;
            console.log(`Game won by: ${winner}`);
        }

        function draw() {
            statusText.innerHTML = 'Draw Game';
            console.log('Game draw');
        }

        /*function resetGame(isMqttMessage = false) {
            console.log('Resetting game');
            player1 = [];
            player2 = [];
            pickedBoard = [0, 1, 2, 3, 4, 5, 6, 7, 8];
            move = 'x';
            gameOverOnWin = false;
            statusText.innerHTML = '';
            cell.forEach(item => {
                item.innerHTML = '';
                item.style.pointerEvents = "auto";
            });
            if (!isMqttMessage) {
                client.publish(`${gameTopic}/reset`);
            }
        }*/

        function showAlert(message) {
            alertText.innerHTML = message;
            console.log(message);
        }

        // Reset button
        document.getElementById('resetButton').addEventListener('click', () => {
            console.log('Resetting game');
            player1 = [];
            player2 = [];
            pickedBoard = [0, 1, 2, 3, 4, 5, 6, 7, 8];
            move = 'x';
            gameOverOnWin = false;
            statusText.innerHTML = '';
            cell.forEach(item => {
                item.innerHTML = '';
                item.style.pointerEvents = "auto";
            });
        });
    </script>
</body>
</html>
